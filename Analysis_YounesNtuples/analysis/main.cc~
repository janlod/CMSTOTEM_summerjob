#include "include/tree_analysis/dxy_phi_correl.h"
#include "include/tree_analysis/dxy_sigmadxy.h"
#include "include/tree_analysis/dz_eta_correl.h"
#include "include/tree_analysis/dz_sigmadz.h"
#include "include/tree_analysis/loopers.h"
#include "include/tree_analysis/momentum_dist.h"
#include "include/tree_analysis/primVertex.h"
#include "include/tree_analysis/pt_eta_correl.h"
#include "include/tree_analysis/plot_chi2.h"

#include "include/invMass_analysis/analysis_inv_mass_hist.h"
#include "include/invMass_analysis/plot_inv_mass.h"

#include "include/data_manipulation/complicated_cuts.h"
#include "include/data_manipulation/dataCombiner.h"
#include "include/data_manipulation/inv_mass.h"
#include "include/data_manipulation/simplecuts.h"
#include "include/data_manipulation/create_chiSquared_tree.h"

#include <filesystem>
#include <fstream>
namespace fs = std::filesystem;


int main(){

    //First we read in all filenames from a text file to a list to loop over them
    std::string line;
    std::ifstream file;
    std::vector<std::string> fileList;
    file.open("dataFileList.txt");
    if(file.is_open()){
        while (getline(file, line)){
            fileList.push_back(line);
        }
        file.close();
    }

    std::string folderpath = "../data/inv_mass_data/"; 
    std::vector<std::string> files2 = { "TOTEM20.root", "TOTEM21.root", "TOTEM22.root", "TOTEM23.root" };
    std::vector<std::string> files4 = { "TOTEM40.root", "TOTEM41.root", "TOTEM42.root", "TOTEM43.root" };
    for(std::string& file : files2){
    	file = folderpath + file;
    }

    for(std::string& file : files4){
    	file = folderpath + file;
    }
    //std::cout<<files2.at(0)<<std::endl;
    //combineTrees(files2, "2");

    int listSize = fileList.size();
    for (int ifile=0; ifile<listSize; ifile++){
        std::string filename = fileList.at(ifile);
        std::string filebasename = filename.erase(filename.size() - 5);

	//add_inv_massBranches("tree", ("/eos/cms/store/group/phys_diffraction/CMSTotemLowPU2018/YounesNtuples/"+filename+".root").c_str(), filename, 0.13957);	

	//TH2F* inv_mass_hist2D = get2D_inv_mass_hist("tree",("../data/inv_mass_data/"+filename + ".root").c_str(), filename, 400, 300, 1200);
	//plot_2D_inv_mass_hist(inv_mass_hist2D, filename);
	//TH1D* projx = getProj(inv_mass_hist2D, 300, 1200, filename, "x");	
	//TH1D* projy = getProj(inv_mass_hist2D, 300, 1200, filename, "y");
	
	//std::array<float, 3> gauss_guess = {1000, 500, 20};
	//gaussfit_kaon_mass(inv_mass_hist2D, filename, gauss_guess, "y");
	//gaussfit_kaon_mass(inv_mass_hist2D, filename, gauss_guess, "x");

       	
    }
	//simpleCut("tree", "/eos/cms/store/group/phys_diffraction/CMSTotemLowPU2018/YounesNtuples/TOTEM20.root", "TOTEM20");


   	

	auto testfilepath = "/eos/user/j/jloder/private/CMSTOTEM_summerjob/Analysis_YounesNtuples/analysis/data/cutted_data/TOTEM20cutted.root";
	auto fpTOTEM2 = "/eos/user/j/jloder/private/CMSTOTEM_summerjob/Analysis_YounesNtuples/analysis/data/combined/TOTEM2.root";
	auto fpTOTEM4 = "/eos/user/j/jloder/private/CMSTOTEM_summerjob/Analysis_YounesNtuples/analysis/data/combined/TOTEM4.root";

	auto fpTOTEM20 = "/eos/cms/store/group/phys_diffraction/CMSTotemLowPU2018/YounesNtuples/TOTEM20.root";
	
	TFile* tot2 = new TFile(fpTOTEM2, "READ");
	TFile* tot4 = new TFile(fpTOTEM4, "READ");

	TTree* treetot2 = (TTree*)tot2->Get("tree");
	TTree* treetot4 = (TTree*)tot4->Get("tree");



	float meanzPV_t2 = -0.291125;
	float meanzPV_t4 = -0.313448;
	float meandxy_sigmadxy_t2 = 0.0016423;
	float meandz_sigmadz_t2 = -0.000467749;
	float meandxy_sigmadxy_t4 = -0.00147728;
	float meandz_sigmadz_t4 = 4.27172e-05;//Fit says 0.00018


	std::vector<float> means_t2 = {meanzPV_t2, meandxy_sigmadxy_t2, meandz_sigmadz_t2};
	std::vector<float> means_t4 = {meanzPV_t4, meandxy_sigmadxy_t4, meandz_sigmadz_t4};

//	std::vector<float> cutoffs = { 30., 30., 30. };
	
	std::vector<std::vector<float>> cutoffs_list;
	for(int i=1; i<10; i++){
		cutoffs_list.push_back({10.0*i, 10.0*i, 10.0*i});
	}
	

	
	auto fp_chi2_TOTEM_cut = "/eos/user/j/jloder/private/CMSTOTEM_summerjob/Analysis_YounesNtuples/analysis/data/chi2_combined/";
	
	auto fp_chi2_TOTEM2 = "/eos/user/j/jloder/private/CMSTOTEM_summerjob/Analysis_YounesNtuples/analysis/data/chi2_combined/TOTEM2chi2.root";
	auto fp_chi2_TOTEM4 = "/eos/user/j/jloder/private/CMSTOTEM_summerjob/Analysis_YounesNtuples/analysis/data/chi2_combined/TOTEM4chi2.root";
	
	TCanvas* c2 = new TCanvas("Fig2", "fig2", 1200, 1000);
	TCanvas* c4 = new TCanvas("Fig4", "fig4", 1200, 1000);
	TLegend* legend2 = new TLegend(0.2, 0.7, 0.5, 0.9);
	legend2->SetBorderSize(0);
        legend2->SetFillStyle(0);
	TLegend* legend4 = new TLegend(0.2, 0.7, 0.5, 0.9);
	legend4->SetBorderSize(0);
        legend4->SetFillStyle(0);
	
	std::vector<Color_t> xColors = {kBlue, kViolet, kBlack};
	std::vector<Color_t> yColors = {kYellow, kOrange, kRed};

	bool first = true;

	for (int i = 3; i < cutoffs_list.size()-3; i++) {
	    std::vector<float> cutoffs = cutoffs_list.at(i);
	    int cut = static_cast<int>(round(cutoffs.at(0)));
	    auto outname2 = "TOTEM2chi2cut" + std::to_string(cut);
	    auto outname4 = "TOTEM2chi4cut" + std::to_string(cut);

	    TH2F* hist2 = get2D_inv_mass_hist("tree", (fp_chi2_TOTEM_cut + outname2 + ".root").c_str(), outname2, 600, 300, 1200);
	    TH2F* hist4 = get2D_inv_mass_hist("tree", (fp_chi2_TOTEM_cut + outname4 + ".root").c_str(), outname4, 600, 300, 1200);

	    // Get colors
	    Color_t xColor = xColors[(i - 3) % xColors.size()];
	    Color_t yColor = yColors[(i - 3) % yColors.size()];

	    // TOTEM2 projections
	    TH1D* projx2 = getProj(hist2, 570, 970, outname2, "x", false);
	    projx2->SetLineColorAlpha(xColor, 0.5);
	    projx2->SetLineWidth(2);
	    legend2->AddEntry(projx2, ("x-proj for cut " + std::to_string(cut)).c_str(), "l");

	    TH1D* projy2 = getProj(hist2, 570, 970, outname2, "y", false);
	    projy2->SetLineColorAlpha(yColor, 0.5);
	    projy2->SetLineWidth(2);
	    legend2->AddEntry(projy2, ("y-proj for cut " + std::to_string(cut)).c_str(), "l");

	    // TOTEM4 projections
	    TH1D* projx4 = getProj(hist4, 570, 970, outname4, "x", false);
	    projx4->SetLineColorAlpha(xColor, 0.5);
	    projx4->SetLineWidth(2);
	    legend4->AddEntry(projx4, ("x-proj for cut " + std::to_string(cut)).c_str(), "l");

	    TH1D* projy4 = getProj(hist4, 570, 970, outname4, "y", false);
	    projy4->SetLineColorAlpha(yColor, 0.5);
	    projy4->SetLineWidth(2);
	    legend4->AddEntry(projy4, ("y-proj for cut " + std::to_string(cut)).c_str(), "l");

	    // Drawing
	    if (first) {
		c2->cd();
		projx2->GetYaxis()->SetRangeUser(0, 2200);
		projx2->Draw("hist");
		projy2->Draw("hist same");

		c4->cd();
		projx4->GetYaxis()->SetRangeUser(0, 2200);
		projx4->Draw("hist");
		projy4->Draw("hist same");

		first = false;
	    } else {
		c2->cd();
		projx2->Draw("hist same");
		projy2->Draw("hist same");

		c4->cd();
		projx4->Draw("hist same");
		projy4->Draw("hist same");
	    }
	}
	
	
	c2->cd();
	legend2->Draw("same");
	c4->cd();
	legend4->Draw("same");

	TFile* outfile2 = new TFile("TOTEM2chi2cuts_projs2.root", "RECREATE");
	c2->Write();
	outfile2->Close();

	
	TFile* outfile4 = new TFile("TOTEM4chi2cuts_projs2.root", "RECREATE");
	c4->Write();
	outfile4->Close();
	//overlay_fits(inv_mass_TOTEM2, gausfit2x, gausfit2y, "TOTEM2chi2cut");
	//overlay_fits(inv_mass_TOTEM4, gausfit4x, gausfit4y, "TOTEM4");


    return 0;

}
